<?php

define('WORD_WIDTH',9);
define('WORD_HIGHT',13);
define('OFFSET_X',7);
define('OFFSET_Y',3);
define('WORD_SPACING',4);

class valite
{
	public function setImage($Image)
	{
		$this->ImagePath = $Image;
	}
	public function getData()
	{
		return $data;
	}
	public function getResult()
	{
		return $DataArray;
	}
	public function getHec()
	{
		$res = imagecreatefromjpeg($this->ImagePath);
		$size = getimagesize($this->ImagePath);
		$data = array();
		for($i=0; $i < $size[1]; ++$i)
		{
			for($j=0; $j < $size[0]; ++$j)
			{
				$rgb = imagecolorat($res,$j,$i);
				$rgbarray = imagecolorsforindex($res, $rgb);
				if($rgbarray['red'] < 125 || $rgbarray['green']<125
				|| $rgbarray['blue'] < 125)
				{
					$data[$i][$j]=1;
				}else{
					$data[$i][$j]=0;
				}
			}
		}
		$this->DataArray = $data;
		$this->ImageSize = $size;
	}
	public function run()
	{
		$result="";
		// 查找4个数字
		$data = array("","","","");
		for($i=0;$i<4;++$i)
		{
			$x = ($i*(WORD_WIDTH+WORD_SPACING))+OFFSET_X;
			$y = OFFSET_Y;
			for($h = $y; $h < (OFFSET_Y+WORD_HIGHT); ++ $h)
			{
				for($w = $x; $w < ($x+WORD_WIDTH); ++$w)
				{
					$data[$i].=$this->DataArray[$h][$w];
				}
			}
			
		}

		// 进行关键字匹配
		foreach($data as $numKey => $numString)
		{
			$max=0.0;
			$num = 0;
			foreach($this->Keys as $key => $value)
			{
				$percent=0.0;
				similar_text($value, $numString,$percent);
				if(intval($percent) > $max)
				{
					$max = $percent;
					$num = $key;
					if(intval($percent) > 95)
						break;
				}
			}
			$result.=$num;
		}
		$this->data = $result;
		// 查找最佳匹配数字
		return $result;
	}

	public function Draw()
	{
		for($i=0; $i<$this->ImageSize[1]; ++$i)
		{
	        for($j=0; $j<$this->ImageSize[0]; ++$j)
		    {
			    echo $this->DataArray[$i][$j];
	        }
		    echo "\n";
		}
	}
	public function __construct()
	{
		$this->Keys = array(
		'0'=>'000111000011111110011000110110000011110000011110000011110000011110000011110000011110000011011000110011111110000111000',
		'1'=>'00000000000000010000000000011100000001111000000010110000000001100000000011000000000110000000001100000000011000000000110000000001100000000111100000001011000000000110000000001100100000011000000000110000001011100000000011000000000110100000001100000000011000000000100000000000000',
		'2'=>'00000000000000011111110001111111100110000001001100000010110000000001100010000110001000001000000000000000000000000000000000000000000100000000011000000001100000010110000000011000000000110000000011000000001100000000110010010001000000001100000000111111111111111111111100000000000',
		'3'=>'00000000000000000000000111111111101111111111000000000010000000001100000010011000000100100000000110000000011000000001110000000011110000000001110001000001110000000001100000000001110000000001110000000001110000001001110000110101110011000001111100000101110000000001000000000000000',
		'4'=>'00000000000000000000000000000000000000000011000000001110000000011100000001111000000110110000001101110000110011000011000110000110001100011000001001100000010110000000101100000001111111111111111111111100000000001000000000010001100000100000000001000000000011000000000100000000000',
		'5'=>'00000000000011111001111111111111111000000000110000000001100000000011001000000110000000001100011110011001111110111110001111111000001111000000000100000000000000000000101000000000000000000000000000000100000000000000000000010000000011100000001110111111110011111111000000000000000',
		'6'=>'00010000000000001111110000111111100011000011000110010010001100000000110000000001100000000011000000001100000001011000000000110000100001101111111011111111110111000000001100000000011000000000110000000001100010000011100000100011100000010011100001000011101110000011111000000000000',
		'7'=>'00100000000010000000000000011111110111111111001110000000011001000000110000000001000000000000000000100100000001000000000010000000100100000000001000000000110000000001100100000011000000000110000000001100000000110000000001100000000011000000000110000100001100000000010000000000000',
		'8'=>'00000000000000000111110010111111100011100011001100000010110000000001100100000011000000000111000000001111000001000111000110000111111000000111100000011111110001110011100110000001011000000000110000000001110000000001100000000011100000100011100011000011111110000011111000000000000',
		'9'=>'00000000000000011111000011111111101100000111110010000011100000000010000000000100000010001100000000011100000000111000000011111000001100111111111100111111000001100000000000000000000000000000010000000000000000000011000000000110000000001110000001001111111110001111111100000000000',
	);
	}
	protected $ImagePath;
	protected $DataArray;
	protected $ImageSize;
	protected $data;
	protected $Keys;
	protected $NumStringArray;

}
?>